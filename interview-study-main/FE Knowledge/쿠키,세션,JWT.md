# 쿠키, 세션, JWT

## 동현

### 쿠키

웹 사이트의 서버에서 클라이언트의 컴퓨터에 저장하는 `작은 기록 정보 파일`을 쿠키라고 합니다. 이름, 값, 만료일, 경로 정보로 구성되어 있으며, 도메인 당 20개의 쿠키를 가질 수 있고, 모든 사이트 통틀어 300개의 정보를 담을 수 있습니다. 각 쿠키는 4KB의 정보만 저장할 수 있기 때문에 적은 양의 데이터를 보관하기에 적합합니다. 

쿠키의 정보는 클라이언트가 보관하기 때문에, 이를 서버에 넘겨줄 때 탈취를 당하는 문제가 발생할 수 있는등 보안에 취약합니다. 따라서, 민감한 정보는 쿠키에 보관하지 않는게 좋습니다.

'오늘 이 창을 다시 보지 않기', '장바구니', '최근 검색 목록' 등에 사용할 수 있습니다.

### 세션

클라이언트가 브라우저를 통해 웹 서버에 연결한 순간부터 웹 브라우저를 닫을 때 까지 들어오는 요청들을 서버 내부에서 식별하고 상태를 관리하는 방식입니다.

쿠키가 사용자 정보를 클라이언트에서 보관하게 하는 방법이었다면, 세션은 서버에서 이를 관리합니다. 사용자 정보를 서버가 보관하기 때문에 비교적 안전한 방법이지만, 세션쿠키 정보를 바탕으로 검증이 필요하기 때문에 속도가 비교적 느린 이슈가 존재합니다.

서버는 사용자의 정보를 보관하기 위해 특정 세션 ID를 키로 하고 대응하는 사용자 정보와 세션의 상태를 값으로 하여 보관합니다. 서버는 사용자에게 세션ID를 세션 쿠키에 담아 전달하고, 사용자는 요청마다 세션 쿠키를 서버에 넘겨 검증하는 절차를 거칩니다.

### JWT (Access Token)

JWT란 인증에 필요한 정보들을 암호화한 토큰입니다. `.(dot)`을 기준으로 세 가지 문자열을 구분합니다. `Header`, `Payload`, `Signature`로 구성됩니다.  
Header는 암호화 해싱 알고리즘 및 토큰의 타입을 지정합니다. Payload는 토큰에 담을 정보를 지니고 있습니다. key-value 형태로 이루어져 있습니다. (한 쌍의 정보를 claim이라 부른다.) Signature는 인코딩된 Header와 Payload를 더한 뒤 비밀키로 해싱하여 생성합니다. 이는 서버 측에서 관리하는 비밀키가 유출되지 않는 이상 복호화 할 수 없습니다. (토큰의 위변조 여부를 확인하는데 사용된다.)

### JWT 장점과 단점

1. 장점
  - 데이터 위변조를 막을 수 있습니다.
  - 인증 정보에 대한 별도의 저장소가 필요 없습니다. (서버가 클라이언트의 정보를 신경쓰지 않아도 됩니다.)
  - 별도의 입출력 작업이 필요없는 빠른 인증 처리가 가능합니다.

2. 단점
  - 토큰의 길이가 길기 때문에, 인증 요청이 많아질수록 네트워크 부하가 심해집니다.
  - payload 자체는 암호화되지 않기 때문에 유저의 중요한 정보는 담기 힘듭니다.
  - 유효기간이 만료될 때 까지 계속 사용 가능하기 때문에 탈취당하면 대처가 어렵습니다.
  - 특정 사용자의 접속을 강제로 만료하기 어렵습니다.

### JWT의 단점을 보완하기 위한 보안 전략
1. 토큰의 만료 기한을 짧게 설정하는 방법이 있습니다. 토큰이 탈취되더라도 빠르게 만료되기 때문에 피해를 최소화 할 수 있습니다. 하지만, 사용자가 토큰을 얻기 위해 자주 로그인을 해야하는 불편함이 따릅니다.

2. Sliding Session을 사용하는 방법이 있습니다. 사용자가 서비스를 지속적으로 사용하는 상황이 발생할 것을 예상하여 토큰 만료 기한을 늘려주는 방식입니다. (글 작성을 시작하거나 결제를 시작할 때 등) 이를 통해, 이용중이던 서비스가 비정상적으로 종료되는 일을 막을 수 있습니다.

3. Refresh Token을 사용하는 방법이 있습니다. Access Token보다 긴 만료기간을 가진 토큰입니다. Access Token이 만료 되었을 때, 서버의 저장된 Refresh Token을 확인해 새로운 Access Token을 발급해줍니다. 이를 통해, 토큰의 만료 기한을 짧게 설정하더라도 새로운 토큰을 발급할 수 있기 때문에 1번의 아쉬운 점을 해결할 수 있습니다. (단, Refresh Token을 저장하는 DB가 별도로 필요하다.)

### 추가 공부 / 궁금한거

- Next.js에서 로그인 여부에 따라 동일 페이지에서 다른 컴포넌트를 렌더링 하기 위해 SSR 방식으로 페이지를 만들어야 할 것 같은데, 그렇다면 SSG/ISR 등의 방식을 채택한 페이지에서 조차 SSR로 변경을 해야하는 문제가 발생.. 말이 안된다고 생각하는데 이를 Next.js에서는 어떻게 해결하는지 학습 할 필요가 있음

- session cookie는 브라우저를 꺼버리면 사라지는 것으로 알고 있다. 근데, session cookie에 max-age 설정을 해서 persistance cookie로 만든다면 사라지지 않고 남을까? (내가 알기로는 남는다..ㅎ) 그러면 서버의 세션 유지 시간 이내에 또 다시 웹페이지에 접속한다면 기존 세션쿠키를 계속해서 사용할 수 있는건지 궁금하다.

- 자동 로그인(로그인 상태 유지)구현을 어떻게 하는지 궁금하다. session / jwt 인증 방식 각각의 경우에 대해 이를 고민해보자. (JDevBook 에서는 어떻게 했지?)

### 참고 자료
- [쿠키와 세션](https://genesis8.tistory.com/220)



## 기태 (정리해야함..)

### 쿠키?
- 브라우저에 저장되는 작은 크기의 문자열입니다.

예시)
- 쿠키(기간 설정, 서버 전송(작은 용량)) : n일 동안 보지않기 / 비로그인 장바구니
- 세션 스토리지() : 이전 페이지 저장 / 이전 스크롤 위치 저장
- 로컬 스토리지 : 사용자 설정 저장 / 글 임시 저장


서버는 쿠키를 이용해서 브라우저에 데이터를 넣을 수 있다.
사이트에 방문하면, 브라우저는 서버에 요청을 보낸다.
서버는 이에 응답하는데, 이 응답에는 모든 데이터와 너가 찾던 페이지 정보가 있다. 또한 그곳에는 브라우저에 저장하고자 하는 쿠키가 있을 수 있다. 너가 브라우저에 쿠키를 저장한 후 해당 웹사이트를 방문할 때 마다 브라우저는 해당 쿠키도 요청과 함께 보내게 된다.
쿠키는 도메인에 따라 제한이 된다. 예로, 유튜브가 준 쿠키는 유튜브에만 보내지게 된다.
그리고 쿠키는 유효기간이 있다. 어떤 쿠키는 하루, 한달, 등 서버가 정한 기간에 따라 유효하다.
쿠키는 인증 뿐만 아니라 여러 정보를 저장할 수 있다. 예를 들면, 웹사이트 언어 설정을 바꾸면 서버는 쿠키를 주고 너가 선택한 언어를 저장한다. 따라서 다음에 너가 해당 웹사이트를 방문하면 쿠키는 요청과 함께 서버로 보내지고 덕분에 서버는 쿠키가 기억해둔 언어설정의 페이지를 제공한다.

왜 세션과 토큰이 필요한지 이해하려면 http를 이해해야하는데, http는 stateless하다. 이 말은 서버로 가는 모든 요청이 이전 요청과 독립적으로 다뤄진다는 것이다. 요청끼리 연결이 없다. 메모리가 없다는 것이다. 요청이 끝나면 서버는 너가 누군지 잊어버린다. 따라서 요청할 때마다 우리가 누군지 알려줘야한다. 이를 하는 방법 중 하나가 바로 세션이다. kitae라는 유저가 있고 로그인하고 싶다면 ID와 비밀번호를 서버에 보낸다. 맞으면 서버는 세션 DB에 kitae 라는 유저를 생성할것이다. 해당 세션은 별도의 ID가 있다. 해당 세션 ID는 쿠키를 통해 브라우저로 들어오고 저장된다. 따라서 같은 웹사이트의 다른 페이지로 이동하면 브라우저는 세션 ID를 갖고있는 쿠키를 서버에게 보낼것이다. 왜냐하면 쿠키는 자동으로 보내지니까. 서버는 들어오는 쿠키를 보고 세션 ID와 같이 오는 쿠키를 확인할것이다. 아직도 서버는 우리가 누구인지 모른다. 세션 ID가 있는 쿠키를 지닌 요청이 있다는 것만 알 뿐이다. 해당 세션 ID를 가지고 세션 DB를 확인할 것이고, 거기서 해당 ID는 유저 kitae의 것이라는 걸 알게되고, 그제서야 서버는 우리가 누구인지 알게되고 그때 안녕하세요 kitae님 이라는 메시지를 띄울것이다. 해당 요청이 끝나고 다른 페이지로 이동하게 되면 이 모든 프로세스가 반복될 것이다. 기억해야 할 것은 중요한 유저 정보는 모두 서버에 있다는 것이다. 유저가 갖고 있는 것은 세션 ID 뿐이다. 즉 쿠키는 그저 세션 ID를 전달하기 위한 매개체일 뿐이다. 세션을 이용해 ios, android 앱을 만들수 있지만 쿠키는 사용할 수 없다. 쿠키는 브라우저에만 있기 때문에. 
이 경우에 토큰을 사용한다. 서버에 토큰을 보내는 것이다. 토큰은 그냥 이상하게 생긴 string이다. 해당 토큰을 서버에 보내고, 서버는 세션 DB에서 해당 토큰과 일치하는 유저를 찾는다. 세션에 대해서 기억해야 할 것은 현재 로그인한 유저들의 모든 세션 ID를 DB에 저장해야한다는 것이다. 즉 요청이 들어올 때마다 서버는 쿠키를 받아서 세션 ID를 보고 세션 ID와 일치하는 유저를 찾아야하고 그제서야 다음 작업을 수행할 수 있다. 요청이 있을 때마다 DB를 찾고 해야 한다는 것이다. 즉 유저가 늘어남 에 따라 DB리소스가 더 필요하다. 이때 JWT가 등장한다. JWT는 토큰 형식이다. JWT로 유저 인증을 처리하면 세션 DB를 가질 필요가 없고, 서버는 유저를 인증한다고 많은 일을 하지 않아도 된다. 토큰은 그냥 이상하게 생긴 텍스트이다. 서버에서 받아서, 요청을 할때마다 보내야 하는 것이다. 로그인 예시를 통해 JWT와 세션의 차이점을 알아보겠다. 
kitae가 로그인을 하려면, 유저명, 비밀번호를 서버에 보내야한다. 여기까진 같다. 유저명 비번이 같다면 서버는 DB에 뭔가를 생성하지 않는다. 대신 서버는 유저의 ID를 가져다가 (예를들면) 사인 알고리즘으로 사인을 한다. 그리고는 해당 사인된 정보를 string 형태로 보낼 것이다. JWT는 보통 세션 ID보다 훨씬 길다. 왜냐하면 쿠키는 또한 공간 제약이 있기 때문이다. JWT는 제약이 없어서 엄청 길어도 된다. 보다시피 동일하게 로그인을 했는데 DB를 건드리는 대신 정보를 사인하고 전달하는 것이 전부이다. 이제 서버에 요청을 보내려면 세션 ID와 비슷하게 해당 사인된 정보 혹은 토큰을 서버에 보내야 한다. 서버는 토큰을 받으면 해당 사인이 유효한지 체크하고,(이는 토큰을 조작했는지 체크하는 것) 토큰이 유효하다면 서버는 우리를 유저로 인증할 것이다. 이것이 세션과 JWT의 가장 큰 차이점이다. 
세션에서는 그냥 세션 ID만 주면 된다. (서버->브라우저)
세션에 대한 모든 정보는 세션 DB에 저장되어 있다. 페이지를 요청하면, 서버는 세션 ID를 DB에서 찾으면 되는 것이다. 
JWT에선 서버는 유저를 인증하는데 필요한 정보를 토큰에 저장한다. 그리고선 해당 토큰을 우리에게 준다. 페이지를 요청하면 서버는 해당 토큰이 유효한지만 검증하면 되는것이다. DB를 거칠 필요 없이. 
염두할 것은, JWT는 암호화 되지 않았다. 암호화되어 있다면, 아무도 읽을 수 없고 이해할 수 없다. JWT의 경우 누구나 열어서 해당 컨텐츠를 볼 수 있다. 비밀 정보를 JWT에 두어선 안될것이다. 핵심은 토큰을 사인하고 이를 통해 유효한지 검증한다는 것이다. 

세션 vs JWT 장단점
세션을 사용하면 서버는 로그인 된 유저의 모든 정보를 저장한다. 해당 정보를 이용하면 새로운 기능들을 추가할 수 있게 된다. 예를들면 특정 유저를 쫓아내고 싶을때 그때 그냥 세션을 삭제해버리면 된다. 인스타그램처럼 할 수 있다. 로그인된 모든 디바이스를 보여주는데 원하지 않는 디바이스에서 강제 로그아웃 할 수 있다. 넷플릭스처럼 계정 공유 숫자를 제한할 수도 있다. 현재 로그인을 몇명이 했고 시청하는지 알수있다. 이 모든 기능이 가능한것은 서버가 누가 로그인했는지 저장했고 세션 DB가 있기 때문이다. 염두해야 할것은 이렇게 다 알고싶다면 DB를 사고 유지해야한다. 유저가 늘어나면 늘어날수록 DB도 커져야한다. 이를 위한 DB로는 주로 Redis를 사용한다. 해당 목적을 수행하기 위한 빠르고 저렴한 DB이다. 
JWT를 사용하면 생성된 토큰을 추적하지 않는다. 서버가 아는것은 토큰이 유효한가의 여부 뿐이다. JWT에서는 DB를 따로 살 필요가 없다. 하지만 아까같은 강제로그아웃같은 기능은 할 수 없다. 해당 토큰이 만료되기 전까지는 유효하기 때문이다. 그렇다고 JWT가 별로인 것은 아니다. 데이터를 사인하고, 유저에게 보내고, 해당 데이터를 돌려 받을 때 유효성을 검증할 수 있다. DB없이 모든 것이 가능하다. 코로나 때문에 하는 QR체크인은 바로 JWT가 들어간 QR코드인것이다. 이처럼 사용사례가 많다. 그중 하나가 세션이나 DB 없이 유저를 인증하는 것이고 JWT 인증의 제약만 잘 알아두면 된다. 

쿠키 = 그냥 옮기는 시스템. 매개체
토큰 = 서버가 기억하는 이상하게 생긴 텍스트. ID카드 처럼 서버에게 보여줘야 하는 것.
JWT = 정보를 갖고 있는 토큰. DB 없이 검증할 수 있음.

유저 인증을 위해서 JWT 또는 세션을 사용할 수 있음.


### 세션?
- 인증된 사용자의 식별자와 랜덤한 문자열로 세션 ID를 만들어서 이를 응답 헤더에 넘겨주고 클라이언트가 저장을 할 수 있도록 만든다.
- 장점 : 클라이언트 쪽에서 사용자의 raw한 데이터를 가지고 있지 않으니까 해커가 정보를 탈취하더라도 크게 위험하지는 않다, 세션의 만료 기간을 정할 수 있기 때문에 만료 기간이 지나면 아무리 해커가 탈취하더라도 유효하지 않다.
- 세션은 서버가 관리한다. 탈취된 세션을 서버에서 삭제하면 이 세션을 이용할 수 없게 된다. : 보안상 이점


### JWT
- Json Web Token 의 약자
- Secret key를 사용해서 JWT를 만들어냅니다. 그리고 Secret Key를 사용해서 JWT의 인증 과정을 거칩니다.
- JWT 자체는 해독하기가 쉽기 때문에 JWT 내에는 민감한 정보를 담지 않습니다. 비밀번호 같은 것.
- Secret key가 중요한 만큼 노출되면 JWT 자체도 끝이다.
- Secret key를 서버 내부에 잘 관리를 해야한다.
# 로드밸런서

## 동현

### 로드밸런싱이란 무엇일까요?

서버로의 트래픽을 적절한 알고리즘을 통해 분산 처리하는 기술을 의미합니다. 이런 기술을 제공하는 서비스나 장치를 로드밸런서라고 합니다. 서비스의 규모가 확장됨에 따라 한 대의 서버만으로는 트래픽 처리가 불가능해져 서버를 증설하는 scale-out 기법을 사용합니다. 여러 대의 서버로 트래픽을 균등하게 분산시켜주기 위해 로드 밸런싱이 필요합니다.

### 여러가지 알고리즘

- 라운드로빈 방식 (Round Robin Method) : 서버에 들어온 요청을 순서대로 돌아가며 배정합니다. 각 서버에 가중치를 설정하여 가중치가 높은 서버 먼저 배정하는 가중 라운드로빈 방식도 존재합니다.
- ip 해시 방식 (IP Hash Method) : 클라이언트의 ip주소를 특정 서버로 매핑해서 배정합니다. 특정 사용자는 특정 서버에게만 요청을 보낼 수 있습니다.
- 최소 연결 방식 (Least Connection Method) : 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 배정하는 방식입니다.

### 로드밸런싱의 문제점

세션 데이터를 관리하는 문제가 있습니다. 예를 들어, A서버가 클라이언트의 정보를 세션으로 관리하고 있었는데 로드밸런서가 이후의 요청을 B서버로 보낸다면 클라이언트의 정보를 가지고 있지 않기 때문에 정보를 다시 달라는 응답을 보내게 됩니다. 이를 예방하기 위해 Sticky Session등의 방법을 이용해 특정 사용자는 동일한 서버에게만 요청이 가도록 만드는 방법이 있습니다. 하지만, 해당 서버에 장애가 발생하면 문제는 같아지며 로드 밸런싱을 하는 의미도 사라지게 됩니다. (또한, 특정 서버에만 과부하가 올수도 있습니다.)

### Sticky Session의 문제점을 해결하는 아이디어

각 서버의 세션을 `클러스터`로 관리하는 방법이 있습니다. 마치 각자의 세션을 하나로 합쳐놓은 것 처럼 동작하게 되어 세션을 공유할 수 있습니다. 하지만, 세션 동기화를 하기 위해 연산 비용이 많이 들며, 네트워크 성능 저하가 발생할 수 있습니다.

`세션만을 위한 서버`를 구축하는 방법도 있는데, 모든 서버가 하나의 세션 저장소를 공유하기 때문에 좋다고 생각합니다. 하지만, 세션 서버의 중요도가 그만큼 올라가게 되고, 세션 서버가 죽어버리면 또 모든 기능이 멈추기 때문에 해당 서버 역시 `다중화`를 고려해야합니다.

### 로드밸런서 종류

L2, L3 로드밸런서는 Port 정보로 분산이 안되기 때문에 잘 사용하지 않습니다. 최소 포트정보로 분산이 가능한 L4 로드밸런서 이상을 사용합니다.

L4 로드밸런서는 포트번호나 TCP/UDP 프로토콜 정보를 바탕으로 트래픽을 나눕니다. 또한 하위 계층의 정보들인 IP주소나 Mac주소를 이용해 나누는 것도 가능합니다. 별도의 데이터 복호화 과정이 필요없고, 단순 패킷에 포함된 정보만을 이용해 나누기 때문에 속도가 빠릅니다.

L7 로드밸런서는 URL 혹은 HTTP 헤더나 쿠키등을 이용해 트래픽 분산을 가능하도록 합니다. 패킷의 내용을 복호화한 데이터를 통해 섬세한 분산 관리가 가능합니다.

### 참고자료

- [로드밸런싱](https://goodgid.github.io/Load-Balancing-And-Clustering/#:~:text=Over%EB%9D%BC%20%ED%95%9C%EB%8B%A4.-,%EB%A1%9C%EB%93%9C%20%EB%B0%B8%EB%9F%B0%EC%8B%B1%EC%9D%98%20%EB%8B%A8%EC%A0%90,%EC%9D%B4%20%EC%9C%A0%EC%A7%80%EB%90%98%EC%A7%80%20%EC%95%8A%EB%8A%94%EB%8B%A4%EB%8A%94%20%EA%B2%83%EC%9D%B4%EB%8B%A4.)
- [L4, L7 로드밸런서](https://m.post.naver.com/viewer/postView.nhn?volumeNo=27046347&memberNo=2521903)
- [Sticky Session](https://kchanguk.tistory.com/146#:~:text=Sticky%20Session%EC%9D%98%20%EA%B0%9C%EB%85%90,%EC%9C%BC%EB%A1%9C%20%EC%84%B8%EC%85%98%EC%9D%84%20%EA%B4%80%EB%A6%AC%ED%95%A9%EB%8B%88%EB%8B%A4.)
- [nginx로 로드밸런싱 하기](https://kamang-it.tistory.com/entry/WebServernginxnginx%EB%A1%9C-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%ED%95%98%EA%B8%B0)
